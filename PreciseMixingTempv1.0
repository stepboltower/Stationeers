## PRECISE GAS MIXING by isyiaco
## Target: mix temperature
## Formula:
## Y=C2*(To-T2)*T1 / (C1*(T1-To)*T2 + C2*(To-T2)*T1)
alias ANALYZERGAS1 d0
alias ANALYZERGAS2 d1
alias GASMIXER d2
alias MEMORYDESIRED d3
alias MEMORYCALCULATED d4
alias LEVER d5
alias GAS1TEMPERATURE r0 # T1 in formula, Kelvin
alias GAS2TEMPERATURE r1 # T2 in formula, Kelvin
alias TEMPERATUREDESIRED r2 # To in formula, Kelvin
alias RATIOCALCULATED r3 # Y in formula, 0..1
alias LEVERSTATE r4
alias TMP1 r5
alias TMP2 r6
alias TMP3 r7
alias TMP4 r8
define GAS1CAPACITY 20.6 # C1 in formula
define GAS2CAPACITY 28.2 # C2 in formula

##
waitlever:
l LEVERSTATE LEVER Open
beq LEVERSTATE 1 main
yield
j waitlever

##
main:
l GAS1TEMPERATURE ANALYZERGAS1 Temperature
l GAS2TEMPERATURE ANALYZERGAS2 Temperature
l TEMPERATUREDESIRED MEMORYDESIRED Setting
## calculation start
sub TMP1 TEMPERATUREDESIRED GAS2TEMPERATURE
mul TMP1 TMP1 GAS2CAPACITY
mul TMP1 TMP1 GAS1TEMPERATURE
sub TMP2 GAS1TEMPERATURE TEMPERATUREDESIRED
mul TMP2 TMP2 GAS1CAPACITY
mul TMP2 TMP2 GAS2TEMPERATURE
sub TMP3 TEMPERATUREDESIRED GAS2TEMPERATURE
mul TMP3 TMP3 GAS2CAPACITY
mul TMP3 TMP3 GAS1TEMPERATURE
add TMP4 TMP2 TMP3
div RATIOCALCULATED TMP1 TMP4
s MEMORYCALCULATED Setting RATIOCALCULATED
## calculation end
mul RATIOCALCULATED 100 RATIOCALCULATED
s GASMIXER Setting RATIOCALCULATED
s GASMIXER On 1
sleep 1
s GASMIXER On 0
s LEVER Open 0
j waitlever
